<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOI Companion App</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/open-fonts@1.1.1/fonts/inter.min.css">
<style>
th{
border:solid;
width:90px !important;
}

</style>
</head>
<body>

<div style="float:left">

 <table id="production" style="background-color:#ADD8E6">
  <tr>
    <th style="border:none">Production:</th>
    <th>1 <text style="font-weight:normal">(1)</text></th>
    <th>2 <text style="font-weight:normal">(1)</text></th>
    <th>3 <text style="font-weight:normal">(2)</text></th>
    <th>4 <text style="font-weight:normal">(2)</text></th>
    <th>5 <text style="font-weight:normal">(2)</text></th>
    <th>6 <text style="font-weight:normal">(3)</text></th>
    <th>7 <text style="font-weight:normal">(3)</text></th>
    <th>8 <text style="font-weight:normal">(3)</text></th>
  <tr>
<td></td>
    <td id="1"></td>
        <td id="2"></td>
              <td id="3"></td>
                    <td id="4"></td>
                    <td id="5"></td>
                    <td id="6"></td>
                    <td id="7"></td>
                    <td id="8"></td>
  </tr>
  <tr>
    <th>9 <text style="font-weight:normal">(4)</text></th>
    <th>10 <text style="font-weight:normal">(4)</text></th>
    <th>11 <text style="font-weight:normal">(4)</text></th>
    <th>12 <text style="font-weight:normal">(5)</text></th>
    <th>13 <text style="font-weight:normal">(5)</text></th>
    <th>14 <text style="font-weight:normal">(5)</text></th>
    <th>15 <text style="font-weight:normal">(6)</text></th>
    <th>16 <text style="font-weight:normal">(6)</text></th>
    <th>17 <text style="font-weight:normal">(6)</text></th>

  </tr>
  <tr>
    <td id="9"></td>
          <td id="10"></td>
                <td id="11"></td>
                <td id="12"></td>
                <td id="13"></td>
                <td id="14"></td>
                <td id="15"></td>
                  <td id="16"></td>
                  <td id="17"></td>
  </tr>
  <tr>
    <th>18 <text style="font-weight:normal">(7)</text></th>
    <th>19 <text style="font-weight:normal">(7)</text></th>
    <th>20 <text style="font-weight:normal">(7)</text></th>
    <th>21 <text style="font-weight:normal">(8)</text></th>
    <th>22 <text style="font-weight:normal">(8)</text></th>
    <th>23 <text style="font-weight:normal">(8)</text></th>
    <th>24 <text style="font-weight:normal">(9)</text></th>
    <th>25 <text style="font-weight:normal">(9)</text></th>
    <th>26 <text style="font-weight:normal">(9)</text></th>

  </tr>
  <tr>
    <td id="18"></td>
          <td id="19"></td>
                <td id="20"></td>
                <td id="21"></td>
                <td id="22"></td>
                <td id="23"></td>
                <td id="24"></td>
                  <td id="25"></td>
                  <td id="26"></td>
  </tr>
  <tr>
    <th>27 <text style="font-weight:normal">(10)</text></th>
    <th>28 <text style="font-weight:normal">(10)</text></th>
    <th>29 <text style="font-weight:normal">(10)</text></th>
    <th>30 <text style="font-weight:normal">(11)</text></th>
    <th>31 <text style="font-weight:normal">(11)</text></th>
    <th>32 <text style="font-weight:normal">(11)</text></th>
    <th>33 <text style="font-weight:normal">(12)</text></th>
    <th>34 <text style="font-weight:normal">(12)</text></th>
    <th>35 <text style="font-weight:normal">(12)</text></th>

  </tr>
  <tr>
    <td id="27"></td>
          <td id="28"></td>
                <td id="29"></td>
                <td id="30"></td>
                <td id="31"></td>
                <td id="32"></td>
                <td id="33"></td>
                  <td id="34"></td>
                  <td id="35"></td>
  </tr>
  <tr>
    <th>36 <text style="font-weight:normal">(13)</text></th>
    <th>37 <text style="font-weight:normal">(13)</text></th>
    <th>38 <text style="font-weight:normal">(13)</text></th>
    <th>39 <text style="font-weight:normal">(14)</text></th>
    <th>40 <text style="font-weight:normal">(14)</text></th>
    <th>41 <text style="font-weight:normal">(14)</text></th>
    <th>42 <text style="font-weight:normal">(15)</text></th>
    <th>43 <text style="font-weight:normal">(15)</text></th>
    <th>44 <text style="font-weight:normal">(15)</text></th>

  </tr>
  <tr>
    <td id="36"></td>
          <td id="37"></td>
                <td id="38"></td>
                <td id="39"></td>
                <td id="40"></td>
                <td id="41"></td>
                <td id="42"></td>
                  <td id="43"></td>
                  <td id="44"></td>
  </tr>
  <tr>
    <th>45 <text style="font-weight:normal">(16)</text></th>
    <th>46 <text style="font-weight:normal">(16)</text></th>
    <th>47 <text style="font-weight:normal">(16)</text></th>
    <th>48 <text style="font-weight:normal">(17)</text></th>
    <th>49 <text style="font-weight:normal">(17)</text></th>

  </tr>
  <tr>
    <td id="45"></td>
          <td id="46"></td>
                <td id="47"></td>
                <td id="48"></td>
                <td id="49"></td>
  </tr>
</table>

 <table id="spheres" style="background-color:#90EE90">
  <tr>
    <th style="border:none">Capitals:</th>
    <th>1</th>
    <th>2</th>
    <th>3</th>
    <th>4</th>
    <th>5</th>
    <th>6</th>
  </tr>
  <tr>
<th>1 Sphere</th>
    <td id="1-1"></td>
    <td id="1-2"></td>
    <td id="1-3"></td>
    <td id="1-4"></td>
    <td id="1-5"></td>
    <td id="1-6"></td>
  </tr>
  <tr>
<th>2 Spheres</th>
<td id="2-1"></td>
<td id="2-2"></td>
<td id="2-3"></td>
<td id="2-4"></td>
<td id="2-5"></td>
<td id="2-6"></td>
  </tr>
  <tr>
<th>3 Spheres</th>
<td id="3-1"></td>
<td id="3-2"></td>
<td id="3-3"></td>
<td id="3-4"></td>
<td id="3-5"></td>
<td id="3-6"></td>
  </tr>
  <tr>
<th>4 Spheres</th>
<td id="4-1"></td>
<td id="4-2"></td>
<td id="4-3"></td>
<td id="4-4"></td>
<td id="4-5"></td>
<td id="4-6"></td>
    </tr>
  <tr>
<th>5 Spheres</th>
<td id="5-1"></td>
<td id="5-2"></td>
<td id="5-3"></td>
<td id="5-4"></td>
<td id="5-5"></td>
<td id="5-6"></td>
  </tr>
  </table>



 <table id="oil" style="background-color:#D3D3D3">
  <tr>
    <th style="border:none">Oil:</th>
    <th>0</th>
    <th>1</th>
    <th>2</th>
    <th>3</th>
    <th>4</th>
    <th>5</th>
    <th>6</th>
    <th>7</th>
  </tr>
  <tr>
<td></td>
<td id="0"></td>
    <td id="1"></td>
          <td id="2"></td>
                <td id="3"></td>
                <td id="4"></td>
                <td id="5"></td>
                <td id="6"></td>

  </tr>
</table>
</div>
<div style="float:left;">
<div style="border:solid;padding:10px;margin:5px">
<input class="usertext chav_box_in"> <button id="send">Send</button> <button>View Map</button>
<div style="width:300px;height:150px;overflow:scroll">
<ul id="chatlog"></ul>
</div>
</div>

  <div style="border:solid;padding:10px;margin:5px">
<center><b>Unit Production</b></center>
<div style="text-align: center">
    <ul id="unitProduction" style="display:inline-block;margin:0;padding:0;list-style:none">
    </ul>
</div>

</div>
  <div id="color-box" style="border:solid;padding:10px;margin:5px;">
<button onclick="nextMove()">Next Turn</button> <button onclick="generateTurnDeck()"style="float:right">Generate New Deck</button>
</div>
</div>


</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>
let players = {};
let capitalsOG = [];
let oil = ["alaska", "alberta", "south_west", "mexico", "venezuela", "brazil", "angola", "nigeria", "libya", "algeria", "iraq", "uae", "saudi_arabia", "iran", "romania", "scandinavia", "england", "urals", "volga", "kazakhstan", "tibet", "indonesia", "far_east", "western_australia"]
let capitals = ["quebec", "east_coast", "mexico", "brazil", "nigeria", "south_africa", "egypt", "saudi_arabia", "iran", "turkey", "germany", "poland", "central", "england", "kazakhstan", "zhongyuan", "india", "indonesia", "japan", "new_south_whales"]
let countries = {
    r1: {
        alaska: 1,
        northwest_territories: 1,
        alberta: 1,
        quebec: 2
    },
    r2: {
        northwest: 1,
        west_coast: 3,
        south_west: 2,
        east_coast: 2,
        great_lakes: 3
    },
    r3: {
        mexico: 3,
        panama: 1,
        cuba: 1,
        colombia: 1,
        venezuela: 1
    },
    r4: {
        brazil: 4,
        peru: 1,
        argentia: 1
    },
    r5: {
        morocco: 1,
        algeria: 1,
        libya: 1,
        egypt: 2
    },
    r6: {
        ivory_coast: 1,
        nigera: 2,
        congo: 1
    },
    r7: {
        ethiopa: 1,
        mozambique: 1,
        angola: 1,
        south_africa: 2,
        madagascar: 1
    },
    r8: {
        spain: 2,
        france: 3,
        germany: 5,
        austria: 2
    },
    r9: {
        italy: 2,
        greece: 2,
        turkey: 3
    },
    r10: {
        poland: 2,
        baltics: 1,
        ukraine: 2,
        romania: 1
    },
    r11: {
        iceland: 1,
        england: 4,
        scandinavia: 2,
        finland: 1
    },
    r12: {
        central: 3,
        volga: 2,
        urals: 1,
        siberia: 1,
        far_east: 1
    },
    r13: {
        kazakhstan: 1,
        uzbekistan: 1,
        turkmenistan: 1
    },
    r14: {
        syria: 1,
        iraq: 1,
        iran: 2,
        afganistan: 1,
        pakistan: 2
    },
    r15: {
        israel: 2,
        saudi_arabia: 2,
        uae: 1,
        yemen: 1
    },
    r16: {
        india: 7,
        burma: 2,
        thailand: 1
    },
    r17: {
        vietnam: 2,
        indonesia: 2,
        new_guinea: 1,
        philippines: 1
    },
    r18: {
        western_australia: 1,
        new_south_whales: 3,
        new_zealand: 1
    },
    r19: {
        tibet: 1,
        zhongyuan: 6,
        lingnan: 3,
        manchuria: 2,
        north_korea: 1
    },
    r20: {
        south_korea: 3,
        taiwan: 2,
        japan: 4
    },
}
let turnDeck = []

const dig = (obj, target) =>
    target in obj ?
    obj[target] :
    Object.values(obj).reduce((acc, val) => {
        if (acc !== undefined) return acc;
        if (typeof val === 'object') return dig(val, target);
    }, undefined);

function loadCookies() {
  players = JSON.parse(getCookie("cookie_players"))
  capitalsOG = getCookie("cookie_capitalsOG").split(",");
  turnDeck = getCookie("cookie_turnDeck").split(",");
  console.log(players)
    for (let i = 0; i < Object.keys(players).length; i++) {
  evaluteScore(Object.keys(players)[i])
  updateBoard(Object.keys(players)[i])
  updateProduction(Object.keys(players)[i])
  }
}
function saveCookies(){
  setCookie("cookie_capitalsOG", capitalsOG.toString(), 7)
  setCookie("cookie_players", JSON.stringify(players), 7)
  setCookie("cookie_turnDeck", turnDeck.toString(), 7)
  console.log(turnDeck)
}
function generateTurnDeck() {
  turnDeck = []
    for (let i = 0; i < Object.keys(players).length; i++) {
      let a = Object.keys(players)[i]
      for (let i = 0; i < players[a].oil+2; i++) {

          turnDeck.push(a)

      }

    }
    function shuffle(array) {
    let currentIndex = array.length;

    // While there remain elements to shuffle...
    while (currentIndex != 0) {

      // Pick a remaining element...
      let randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;

      // And swap it with the current element.
      [array[currentIndex], array[randomIndex]] = [
        array[randomIndex], array[currentIndex]];
    }
  }

    shuffle(turnDeck)

    turnDeck.push("white")
    $("#color-box").css('background-color', 'white');
console.log(turnDeck)
saveCookies();
}
function nextMove(){
  $("#color-box").css('background-color', turnDeck[0]);
  if(turnDeck.length == 1)
  {

    return;
  } else {

      turnDeck.shift();
      saveCookies();

}
}
function list(color){
  if (Object.keys(players).includes(color)) {
return players[color].countries.toString()
}
else {
  return "Failure"
}
}
function deleteCountry(color,country){
    if (Object.keys(players).includes(color) && Object.keys(countries).reduce((acc, val) => [...acc, ...Object.keys(countries[val])], []).includes(country) && players[color].countries.includes(country)) {
  const index = players[color].countries.indexOf(country);
  players[color].countries.splice(index, 1);
  evaluteScore(color)
  updateBoard(color)
  updateProduction(color)
  saveCookies();
  return "Success";

} else{
  return "Failure"
}
}



Object.defineProperty(String.prototype, 'capitalize', {
  value: function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
  },
  enumerable: false
});

function updateProduction() {
  let scores = {};
    for (let i = 0; i < Object.keys(players).length; i++) {
      scores[i] = {}
      scores[i]["name"] = Object.keys(players)[i]
      scores[i]["production"] = players[Object.keys(players)[i]].production
      scores[i]["spheres"] = players[Object.keys(players)[i]].spheres
      scores[i]["capitals"] = players[Object.keys(players)[i]].capitals
      scores[i]["oil"] = players[Object.keys(players)[i]].oil
    scores[i]["overall"] = players[Object.keys(players)[i]].production + players[Object.keys(players)[i]].capitalsOG + players[Object.keys(players)[i]].spheres


  }
let array = Object.values(scores)
array.sort((x,y) => {
    if (x.production < y.production) { return 1; }
    else if (x.production > y.production) { return -1; }
    else {
        if (x.spheres < y.spheres) {return 1; }
        else if (x.spheres > y.spheres) {return -1; }
        else {

          if (x.capitals < y.capitals) {return 1; }
          else if (x.capitals > y.capitals) {return -1; }
          else {


            if (x.oil < y.oil) {return 1; }
            else if (x.oil > y.oil) {return -1; }
            else {
              x.overall = `${x.overall} (Tied)`
              y.overall = `${y.overall} (Tied)`

             }
           }
         }
    }
})
$(`#unitProduction`).empty()
for (let i = 0; i < array.length; i++) {
$(`#unitProduction`).append(`<li style="float:left; padding: 2px 5px;"><text style="color:${array[i].name}">${array[i].name.capitalize()}: </text><text>${array[i].overall}</text></li>`)

}
}

function updateBoard(color) {
$(`#production #${color}`).remove();
$(`#production #${players[color].production}`).append(`<text id="${color}" style="color:${color}">■</text>`)
$(`#oil #${color}`).remove();
$(`#oil #${players[color].oil}`).append(`<text id="${color}" style="color:${color}">■</text>`)
$(`#spheres #${color}`).remove();
$(`#spheres #${players[color].spheres}-${players[color].capitals}`).append(`<text id="${color}" style="color:${color}">■</text>`)
}

function appendChat(e) {
    var id = e.target.id;
    var notEmpty = $(".usertext").val() != "",
        isEnterKeypress = e.type == "keypress" && e.keyCode == 13,
        isSendClick = e.type == "click" && id == "send";

    if (notEmpty && (isEnterKeypress || isSendClick)) {

        var txt = $(".usertext").val().toLowerCase();
        var words = txt.split(' ');
        $("#chatlog").prepend($("<li>").html(txt));
        $(".usertext").val("");

        if (words[0] == "register") {
            var response = registerPlayer(words[1], words.slice(2).join("_"))
            $("#chatlog").prepend($("<li style=list-style-type:\"→\">").html(response));
            $(".usertext").val("");
        } else if (words[0] == "reset") {
            players = {}
            capitalsOG = []
            $("#chatlog").prepend($("<li style=list-style-type:\"→\">").html("Game reset!"));
            $(".usertext").val("");
        } else if (words[0] == "play") {
          var response = play(words[1], words.slice(2).join("_"))
          $("#chatlog").prepend($("<li style=list-style-type:\"→\">").html(response));
          $(".usertext").val("");
        } else if (words[0] == "list") {
          var response = list(words[1])
          $("#chatlog").prepend($("<li style=list-style-type:\"→\">").html(response));
          $(".usertext").val("");
        } else if (words[0] == "delete") {
          var response = deleteCountry(words[1], words.slice(2).join("_"))
          $("#chatlog").prepend($("<li style=list-style-type:\"→\">").html(response));
          $(".usertext").val("");
        } else if (words[0] == "load") {
          var response = loadCookies()
          $("#chatlog").prepend($("<li style=list-style-type:\"→\">").html(response));
          $(".usertext").val("");
        }

    }
}


function play(color, country) {
  if (Object.keys(players).includes(color) && Object.keys(countries).reduce((acc, val) => [...acc, ...Object.keys(countries[val])], []).includes(country) && !(players[color].countries.includes(country))) {
    for (let i = 0; i < Object.keys(players).length; i++) {
        if (players[Object.keys(players)[i]].countries.includes(country)){

const index = players[Object.keys(players)[i]].countries.indexOf(country);
players[Object.keys(players)[i]].countries.splice(index, 1);
evaluteScore(Object.keys(players)[i])
updateBoard(Object.keys(players)[i])
updateProduction(Object.keys(players)[i])
        }
          }
      players[color].countries.push(country)
      evaluteScore(color)
      updateBoard(color)
      updateProduction(color)
saveCookies();
      return("Success!")
  } else {
    return("Either color / country is wrong!");

  }
}

function evaluteScore(color) {
    let totalProduction = 0;
    let totalOil = 0;
    let totalSpheres = 0;
    let totalCapitals = 0;
    let totalCapitalsOG = 0;
    for (let i = 0; i < players[color].countries.length; i++) {
        totalProduction = totalProduction + dig(countries, players[color].countries[i])

        if (oil.includes(players[color].countries[i])) {
            totalOil = totalOil + 1
        }
        if (capitalsOG.includes(players[color].countries[i])) {
            totalCapitalsOG = totalCapitalsOG + 1
        }
        if (capitals.includes(players[color].countries[i])) {
            totalCapitals = totalCapitals + 1
        }
    }
    for (let i = 0; i < 20; i++) {
        let a = i + 1
        if (Object.keys(countries["r" + a]).every(val => players[color].countries.includes(val))) {
            totalSpheres = totalSpheres + 1
        }

    }
    players[color]["production"] = totalProduction;
    players[color]["capitals"] = totalCapitals;
    players[color]["capitalsOG"] = totalCapitalsOG;
    players[color]["oil"] = totalOil;
    players[color]["spheres"] = totalSpheres;
    console.log(players)
saveCookies();
}


function registerPlayer(color, capital) {
  if(Object.keys(players).includes(color) || capitalsOG.includes(capital)){
    return("Player/capital already registered!")
  } else {
    if (Object.keys(countries).reduce((acc, val) => [...acc, ...Object.keys(countries[val])], []).includes(capital)) {
        capitalsOG.push(capital)
        players[color] = {
            "countries": [capital]
        }
        evaluteScore(color);
        updateBoard(color);
        updateProduction(color);
        return (`Registered ${color}`)
    } else {
        return ("Not a valid country!")
    }
}
saveCookies();
}

$("#send").click(appendChat);
$(".chav_box_in").keypress(appendChat);



function setCookie(name, value, days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
}

function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function eraseCookie(name) {
    document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
}
</script>
</html>
